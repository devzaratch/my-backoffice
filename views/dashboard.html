<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard ‚Äî Backoffice</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .stat-card { transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-3px); }
    .chart-container { height: 300px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
      <span class="navbar-brand">üìä Dashboard</span>
      <div class="d-flex align-items-center">
        <a href="/" class="btn btn-outline-light btn-sm me-2">
          <i class="bi bi-table"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
        </a>
        <span class="text-white me-3">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, Admin</span>
        <a href="/logout" class="btn btn-outline-light btn-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ -->
    <div class="row g-4 mb-4" id="summaryCards">
      <div class="col-md-3">
        <div class="card stat-card bg-primary text-white">
          <div class="card-body">
            <h6 class="card-subtitle mb-2">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6>
            <h3 class="card-title mb-0" id="totalUsers">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card bg-success text-white">
          <div class="card-body">
            <h6 class="card-subtitle mb-2">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</h6>
            <h3 class="card-title mb-0" id="approvedUsers">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card bg-warning text-dark">
          <div class="card-body">
            <h6 class="card-subtitle mb-2">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h6>
            <h3 class="card-title mb-0" id="pendingUsers">-</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card bg-danger text-white">
          <div class="card-body">
            <h6 class="card-subtitle mb-2">‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏£‡∏ß‡∏°</h6>
            <h3 class="card-title mb-0" id="totalCredit">-</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- ‡∏Å‡∏£‡∏≤‡∏ü -->
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h6>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (7 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)</h6>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="dailyChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dashboard
    fetch('/users/dashboard')
      .then(res => res.json())
      .then(data => {
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πå‡∏î
        document.getElementById('totalUsers').textContent = data.summary.total;
        document.getElementById('approvedUsers').textContent = data.summary.approved;
        document.getElementById('pendingUsers').textContent = data.summary.pending;
        document.getElementById('totalCredit').textContent = 
          parseFloat(data.summary.total_credit).toLocaleString('th-TH', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
          }) + ' LAK_THB';

        // ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
          type: 'pie',
          data: {
            labels: data.statusChart.labels,
            datasets: [{
              data: data.statusChart.data,
              backgroundColor: ['#2E7D32', '#FFC107', '#D32F2F'],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });

        // ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        new Chart(dailyCtx, {
          type: 'line',
          data: {
            labels: data.dailyChart.labels,
            datasets: [{
              label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£',
              data: data.dailyChart.data,
              borderColor: '#2E7D32',
              backgroundColor: 'rgba(46, 125, 50, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, ticks: { precision: 0 } }
            },
            plugins: { legend: { display: false } }
          }
        });
      })
      .catch(err => {
        console.error('‡πÇ‡∏´‡∏•‡∏î Dashboard ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', err);
        alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dashboard ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
      });
  </script>
</body>
</html>